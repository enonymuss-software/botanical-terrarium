<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Origin Engine: Atmospheric Terrarium</title>
    <style>
        body { margin: 0; background-color: #000; color: #00ffcc; font-family: 'Courier New', monospace; overflow: hidden; }
        #ui-layer { 
            position: absolute; top: 20px; left: 20px; z-index: 10; 
            background: rgba(0, 10, 10, 0.9); padding: 20px; 
            border: 1px solid #00ffcc; border-radius: 8px;
            pointer-events: auto; width: 280px; box-shadow: 0 0 20px rgba(0, 255, 204, 0.3);
        }
        .status-text { font-size: 1.2rem; font-weight: bold; color: #fff; text-transform: uppercase; letter-spacing: 2px; }
        .readout { font-size: 0.85rem; margin: 10px 0; color: #00ffcc; line-height: 1.4; border-bottom: 1px solid #004444; padding-bottom: 10px;}
        label { display: block; margin-top: 12px; color: #00ffcc; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #00ffcc; }
        .legend { margin-top: 15px; font-size: 0.7rem; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
        button { 
            width: 100%; margin-top: 15px; background: #004444; border: 1px solid #00ffcc; 
            color: #00ffcc; padding: 10px; cursor: pointer; font-family: inherit; font-weight: bold;
        }
        button:hover { background: #00ffcc; color: #050505; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="status-text">Terrarium v3</div>
        <div id="env-readout" class="readout">INITIALIZING...</div>

        <label>üå°Ô∏è Temperature (¬∞C)</label>
        <input type="range" id="heatSlider" min="-20" max="50" value="20">
        
        <label>üíß Precipitation (Intensity)</label>
        <input type="range" id="rainSlider" min="0" max="100" value="30">

        <label>‚è≥ System Speed</label>
        <input type="range" id="timeSlider" min="0.1" max="5" step="0.1" value="1">

        <button id="reseedBtn">Reseed Habitat</button>

        <div class="legend">
            <div class="legend-item"><div class="dot" style="background: #22ff22;"></div> VIBRANT (Healthy)</div>
            <div class="legend-item"><div class="dot" style="background: #ff66cc;"></div> BLOOMING (Perfect)</div>
            <div class="legend-item"><div class="dot" style="background: #886622;"></div> PARCHED (Heat Stress)</div>
            <div class="legend-item"><div class="dot" style="background: #66ccff;"></div> FROZEN (Cold Stress)</div>
        </div>
    </div>

    <div id="world-container"></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- 1. CORE SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 12, 18);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('world-container').appendChild(renderer.domElement);

        const worldGroup = new THREE.Group();
        scene.add(worldGroup);

        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(5, 10, 5);
        scene.add(sun);

        // --- 2. GROUND & FROST ---
        const groundGeo = new THREE.CylinderGeometry(9, 9, 0.8, 32);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x221100 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.position.y = -0.4;
        worldGroup.add(ground);

        // --- 3. WEATHER PARTICLES (RAIN/SNOW) ---
        const pCount = 1000;
        const pGeo = new THREE.BufferGeometry();
        const pPos = new Float32Array(pCount * 3);
        for(let i=0; i<pCount; i++){
            pPos[i*3] = (Math.random()-0.5)*20;
            pPos[i*3+1] = Math.random()*20;
            pPos[i*3+2] = (Math.random()-0.5)*20;
        }
        pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        const pMat = new THREE.PointsMaterial({ size: 0.1, transparent: true, opacity: 0.6 });
        const weatherSystem = new THREE.Points(pGeo, pMat);
        scene.add(weatherSystem);

        // --- 4. PLANT SYSTEM ---
        let plants = [];
        const plantGroup = new THREE.Group();
        worldGroup.add(plantGroup);

        function createPlant() {
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.random() * 7;
            const x = Math.cos(angle) * dist, z = Math.sin(angle) * dist;
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.1, 0.15), new THREE.MeshStandardMaterial({ color: 0x22ff22 }));
            mesh.position.set(x, 0, z);
            plantGroup.add(mesh);
            return { mesh, age: 0, health: 100, stage: 'growing' };
        }

        // --- 5. LOGIC & CONTROLS ---
        const hSlider = document.getElementById('heatSlider'), rSlider = document.getElementById('rainSlider');
        const tSlider = document.getElementById('timeSlider'), readout = document.getElementById('env-readout');
        document.getElementById('reseedBtn').onclick = () => { for(let i=0; i<20; i++) plants.push(createPlant()); };
        for(let i=0; i<30; i++) plants.push(createPlant());

        let humidity = 50;

        function animate() {
            requestAnimationFrame(animate);
            const temp = parseFloat(hSlider.value), intensity = parseFloat(rSlider.value), speed = parseFloat(tSlider.value);

            // A. ATMOSPHERE LOGIC
            humidity += (intensity * 0.04 - temp * 0.02) * speed;
            humidity = Math.max(0, Math.min(100, humidity));

            // B. WEATHER VISUALS
            const positions = weatherSystem.geometry.attributes.position.array;
            const isCold = temp <= 0;
            pMat.color.setHex(isCold ? 0xffffff : 0x44aaff);
            pMat.opacity = intensity / 100;
            
            for(let i=0; i<pCount; i++) {
                // Falling speed: Snow is slower/driftier than rain
                positions[i*3+1] -= (isCold ? 0.05 : 0.2) * (intensity/50) * speed;
                if(isCold) positions[i*3] += Math.sin(Date.now()*0.001 + i)*0.02; // Swaying snow

                if(positions[i*3+1] < 0) positions[i*3+1] = 20; // Reset to top
            }
            weatherSystem.geometry.attributes.position.needsUpdate = true;

            // C. FROST LOGIC (Ground Color)
            const frostLevel = isCold ? Math.min(1, Math.abs(temp)/20) : 0;
            groundMat.color.lerpColors(new THREE.Color(0x221100), new THREE.Color(0xeeeeff), frostLevel);

            // D. PLANT LIFECYCLE
            for (let i = plants.length - 1; i >= 0; i--) {
                let p = plants[i];
                const stress = (temp > 38 || temp < 5 || humidity < 15 || humidity > 95);
                
                if (stress) {
                    p.health -= 0.15 * speed;
                    p.stage = temp < 5 ? 'frozen' : 'withering';
                } else if (temp > 18 && temp < 28 && humidity > 45 && humidity < 65) {
                    p.health += 0.1 * speed;
                    p.stage = 'blooming';
                } else {
                    p.stage = 'growing';
                }

                p.age += 0.005 * speed;
                const size = Math.min(3, p.age * (p.health / 100));
                p.mesh.scale.set(1, size * 8, 1);
                p.mesh.position.y = (size * 8) / 20;

                // Color mapping
                if (p.health <= 0) {
                    p.mesh.material.color.setHex(0x332211);
                    if (p.mesh.scale.y > 0.1) p.mesh.scale.y *= 0.98;
                    else { plantGroup.remove(p.mesh); plants.splice(i, 1); }
                } else {
                    if (p.stage === 'blooming') p.mesh.material.color.setHex(0xff66cc);
                    else if (p.stage === 'frozen') p.mesh.material.color.setHex(0x66ccff);
                    else if (p.stage === 'withering') p.mesh.material.color.setHex(0x886622);
                    else p.mesh.material.color.setHex(0x22ff22);
                }
            }

            readout.innerHTML = `TEMP: ${temp}¬∞C | HUMIDITY: ${Math.round(humidity)}%<br>STATE: ${isCold ? '‚ùÑÔ∏è FREEZING' : (temp > 35 ? 'üî• SCORCHING' : 'üå§Ô∏è STABLE')}`;
            worldGroup.rotation.y += 0.001;
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
